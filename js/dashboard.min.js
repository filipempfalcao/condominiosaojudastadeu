// Versão minificada do dashboard.js com gráficos de barras empilhadas
window.statusLabels={aberta:"Aberta","em-analise":"Em Análise","em-andamento":"Em Andamento","aguardando-terceiros":"Aguardando Terceiros",resolvida:"Resolvida",cancelada:"Cancelada"},window.criticidadeLabels={baixa:"Baixa",media:"Média",alta:"Alta"},window.criticidadeClasses={baixa:"badge-success",media:"badge-warning",alta:"badge-danger"},window.statusClasses={aberta:"badge-secondary","em-analise":"badge-info","em-andamento":"badge-primary","aguardando-terceiros":"badge-warning",resolvida:"badge-success",cancelada:"badge-danger"},window.formatarData=function(a){return new Date(a).toLocaleDateString("pt-BR")},window.obterDados=function(a,b){const c=localStorage.getItem(a);return c?JSON.parse(c):b},window.mostrarNotificacao=function(a,b){alert(a)},document.addEventListener("DOMContentLoaded",function(){const a=window.obterDados("demandas",[]),b=document.getElementById("totalDemandas"),c=document.getElementById("totalDemandasChange"),d=document.getElementById("demandasAbertas"),e=document.getElementById("demandasAbertasChange"),f=document.getElementById("tempoMedio"),g=document.getElementById("tempoMedioChange"),h=document.getElementById("taxaResolucao"),i=document.getElementById("taxaResolucaoChange"),j=document.getElementById("periodoFilter"),k=document.getElementById("demandasCriticas"),l=document.getElementById("demandasChart").getContext("2d"),m=document.getElementById("evolucaoChart").getContext("2d");let n=null,o=null;function p(){const p=parseInt(j.value),q=new Date,r=new Date(q);r.setDate(q.getDate()-p);const s=a.filter(a=>{const b=new Date(a.data);return b>=r}),t=new Date(r);t.setDate(t.getDate()-p);const u=a.filter(a=>{const b=new Date(a.data);return b>=t&&b<r}),v=s.length,w=s.filter(a=>"aberta"===a.status||"em-analise"===a.status||"em-andamento"===a.status||"aguardando-terceiros"===a.status).length,x=s.filter(a=>"resolvida"===a.status).length,y=v>0?x/v*100:0;let z=0,A=0;s.forEach(a=>{if("resolvida"===a.status&&a.dataResolucao){const b=new Date(a.data),c=new Date(a.dataResolucao),d=Math.floor((c-b)/(1e3*60*60*24));z+=d,A++}});const B=A>0?z/A:8.5,C=u.length,D=u.filter(a=>"aberta"===a.status||"em-analise"===a.status||"em-andamento"===a.status||"aguardando-terceiros"===a.status).length,E=u.filter(a=>"resolvida"===a.status).length,F=C>0?E/C*100:0;let G=0,H=0;u.forEach(a=>{if("resolvida"===a.status&&a.dataResolucao){const b=new Date(a.data),c=new Date(a.dataResolucao),d=Math.floor((c-b)/(1e3*60*60*24));G+=d,H++}});const I=H>0?G/H:10.8,J=C>0?(v-C)/C*100:0,K=D>0?(w-D)/D*100:0,L=I>0?B-I:0,M=F>0?y-F:0;b.textContent=v,c.textContent=`${J>=0?"+":""}${J.toFixed(1)}% em relação ao período anterior`,c.className=`stat-change ${J>=0?"positive":"negative"}`,d.textContent=w,e.textContent=`${K>=0?"+":""}${K.toFixed(1)}% em relação ao período anterior`,e.className=`stat-change ${K>=0?"positive":"negative"}`,f.textContent=`${B.toFixed(1)} dias`,g.textContent=`${L>=0?"+":""}${L.toFixed(1)} dias em relação ao período anterior`,g.className=`stat-change ${L<=0?"positive":"negative"}`,h.textContent=`${y.toFixed(1)}%`,i.textContent=`${M>=0?"+":""}${M.toFixed(1)}% em relação ao período anterior`,i.className=`stat-change ${M>=0?"positive":"negative"}`,function(a){const b={abertas:["aberta","em-analise","em-andamento","aguardando-terceiros"],encerradas:["resolvida","cancelada"]},c={};a.forEach(a=>{c[a.categoriaLabel]||(c[a.categoriaLabel]={abertas:0,encerradas:0});let d="abertas";b.encerradas.includes(a.status)&&(d="encerradas"),c[a.categoriaLabel][d]++});const d=Object.keys(c),e=d.map(a=>c[a].abertas),f=d.map(a=>c[a].encerradas);n&&n.destroy(),n=new Chart(l,{type:"bar",data:{labels:d,datasets:[{label:"Demandas Abertas",data:e,backgroundColor:"rgba(54, 162, 235, 0.8)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1},{label:"Demandas Encerradas",data:f,backgroundColor:"rgba(75, 192, 192, 0.8)",borderColor:"rgba(75, 192, 192, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{stacked:!0,title:{display:!0,text:"Categoria"}},y:{stacked:!0,beginAtZero:!0,ticks:{precision:0},title:{display:!0,text:"Quantidade"}}},plugins:{legend:{position:"top",labels:{usePointStyle:!0,padding:15}},tooltip:{mode:"index",intersect:!1}}}})}(s),function(b){const c={},d={};for(let a=5;a>=0;a--){const b=new Date(q);b.setMonth(q.getMonth()-a);const e=`${b.getMonth()+1}/${b.getFullYear()}`;c[e]=0,d[e]=0}a.forEach(a=>{const b=new Date(a.data),e=`${b.getMonth()+1}/${b.getFullYear()}`;void 0!==c[e]&&c[e]++,"resolvida"===a.status&&a.dataResolucao&&(b=>{const a=new Date(b),e=`${a.getMonth()+1}/${a.getFullYear()}`;void 0!==d[e]&&d[e]++})(a.dataResolucao)});const e=Object.keys(c),f=Object.values(c),g=Object.values(d);o&&o.destroy(),o=new Chart(m,{type:"line",data:{labels:e,datasets:[{label:"Novas Demandas",data:f,borderColor:"rgba(54, 162, 235, 1)",backgroundColor:"rgba(54, 162, 235, 0.2)",tension:.4,fill:!0},{label:"Demandas Resolvidas",data:g,borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{precision:0}}},plugins:{legend:{position:"top"}}}})}(),function(){const b=a.filter(a=>"alta"===a.criticidade&&"resolvida"!==a.status&&"cancelada"!==a.status);b.sort((a,b)=>new Date(b.data)-new Date(a.data));const c=b.slice(0,3);if(k.innerHTML="",0===c.length)return void(k.innerHTML='\n        <div class="demand-item text-center">\n          <p>Não há demandas críticas no momento.</p>\n        </div>\n      ');c.forEach(b=>{const c=document.createElement("div");c.className="demand-item",c.innerHTML=`\n        <div class="demand-header">\n          <div class="demand-title">${b.titulo}</div>\n          <div class="demand-id">ID: ${b.id}</div>\n        </div>\n        <div class="demand-meta">\n          <div>${b.categoriaLabel} | ${window.formatarData(b.data)}</div>\n          <div class="demand-badges">\n            <span class="badge ${window.criticidadeClasses[b.criticidade]}">${window.criticidadeLabels[b.criticidade]}</span>\n            <span class="badge ${window.statusClasses[b.status]}">${window.statusLabels[b.status]}</span>\n          </div>\n        </div>\n        <div class="text-right">\n          <a href="#" class="btn btn-outline btn-sm visualizar-demanda" data-id="${b.id}">Detalhes</a>\n        </div>\n      `,k.appendChild(c)}),document.querySelectorAll(".visualizar-demanda").forEach(b=>{b.addEventListener("click",function(b){b.preventDefault();const c=this.getAttribute("data-id");!function(b){const c=a.find(a=>a.id===b);c?alert(`\n        Demanda: ${c.titulo}\n        ID: ${c.id}\n        Categoria: ${c.categoriaLabel}\n        Data: ${window.formatarData(c.data)}\n        Criticidade: ${window.criticidadeLabels[c.criticidade]}\n        Status: ${window.statusLabels[c.status]}\n        Localização: ${c.localizacao}\n        Descrição: ${c.descricao}\n        ${c.custo>0?`Custo: R$ ${c.custo.toFixed(2)}`:"Custo: Não definido"}\n      `):window.mostrarNotificacao("Demanda não encontrada","erro")}(c)})})}()}j.addEventListener("change",p),setTimeout(function(){try{p(),console.log("Dashboard inicializado com sucesso")}catch(a){console.error("Erro ao inicializar dashboard:",a)}},500)});
